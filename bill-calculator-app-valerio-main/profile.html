<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile</title>
    <link rel="stylesheet" href="profile.css">
</head>
<body>

<div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <nav class="nav-menu">
        <ul>
          <li class="active"><a href="profile.html">üë§ Profile</a></li>
          <li><a href="dashboard.html">üî≤ Dashboard</a></li>
          <li><a href="calculator.html">üßÆ Calculator</a></li>
          <li><a href="history.html">‚è≥ History</a></li>
          <li><a href="#" onclick="handleLogout(); return false;">‚Ü™ Logout</a></li>
        </ul>
      </nav>
      <div class="sidebar-logo">
        <img src="image/logo.png" alt="WattWise Logo">
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">
        <div class="header">
            <h2>My Profile</h2>
        </div>

        <!-- CENTERED PROFILE FORM -->
        <div class="profile-container">
            <h1>User Profile</h1>

            <form onsubmit="event.preventDefault(); handleProfileUpdate();">
                <div>
                    <label for="profile_name">Username</label>
                    <input type="text" id="profile_name" name="profile_name" placeholder="Your username" />
                </div>

                <div>
                    <label for="profile_email">Email Address</label>
                    <input type="email" id="profile_email" name="profile_email" placeholder="Your email" />
                </div>

                <div>
                    <label for="profile_phone">Contact Number</label>
                    <input type="tel" id="profile_phone" name="profile_phone" placeholder="Your phone number" />
                </div>

                <div>
                    <label for="profile_password">Change Password</label>
                    <input type="password" id="profile_password" name="profile_password" placeholder="New password (optional)" />
                </div>

                <button type="submit">Update Profile</button>
            </form>
        </div>
    </main>

</div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>
<script src="auth.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        if (window.requireAuth) {
            if (!await window.requireAuth()) return; // redirect if not authenticated
        }
        const session = await initAuth();
        console.debug('DOMContentLoaded session:', session);
        if (session) await loadUserProfile();
    });

    async function initAuth() {
        if (window.supabaseClient) return await checkAuth();
        await new Promise((r) => {
            const i = setInterval(() => { if (window.supabaseClient) { clearInterval(i); r(); } }, 100);
            setTimeout(() => { clearInterval(i); r(); }, 5000);
        });
        const s = await checkAuth();
        console.debug('initAuth result:', s);
        return s;
    }

    async function getCurrentUser() {
        if (!window.supabaseClient) return null;
        try {
            const { data: { user }, error } = await supabaseClient.auth.getUser();
            if (error) { console.error('getUser error', error); return null; }
            console.debug('getCurrentUser', user);
            return user;
        } catch (e) { console.error('getCurrentUser exception', e); return null; }
    }

    async function loadUserProfile() {
        const user = await getCurrentUser();
        if (!user) { console.warn('No user session - loadUserProfile aborted'); return; }
        console.debug('loadUserProfile user metadata:', user.user_metadata);
        document.getElementById('profile_name').value = user.user_metadata?.full_name || '';
        document.getElementById('profile_email').value = user.email || '';
        document.getElementById('profile_phone').value = user.user_metadata?.phone || '';
    }

    async function handleProfileUpdate() {
        const name = document.getElementById('profile_name').value;
        const phone = document.getElementById('profile_phone').value;
        const password = document.getElementById('profile_password').value;

        const user = await getCurrentUser();
        if (!user) { alert('You must be logged in!'); return; }

        try {
            const updateObj = { data: { full_name: name, phone } };
            if (password) updateObj.password = password;
            console.debug('Updating user with', updateObj);
            const { data, error } = await supabaseClient.auth.updateUser(updateObj);
            if (error) { console.error('updateUser error', error); alert('Error: ' + error.message); return; }
            console.debug('updateUser result', data);
            alert('Profile updated successfully!');
            if (password) document.getElementById('profile_password').value = '';
        } catch (err) {
            console.error('handleProfileUpdate exception', err);
            alert('Error: ' + (err.message || err));
        }
    }

    async function handleLogout() {
        if (confirm('Are you sure you want to logout?')) {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        }
    }
</script>

</body>
</html>
