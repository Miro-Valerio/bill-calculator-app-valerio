<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WattWise ‚Äî Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="auth.js"></script>
</head>

<body>
  <div class="app">

    <!-- HAMBURGER ICON -->
    <div class="hamburger" onclick="toggleMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <nav>
        <ul>
          <li><a href="profile.html">üë§ Profile</a></li>
          <li class="active"><a href="dashboard.html">üî≤ Dashboard</a></li>
          <li><a href="calculator.html">üßÆ Calculator</a></li>
          <li><a href="history.html">‚è≥ History</a></li>
          <li><a href="#" onclick="handleLogout(); return false;">‚Ü™ Logout</a></li>
        </ul>
      </nav>

      <div class="sidebar-logo">
        <img src="image/logo.png" alt="WattWise logo">
      </div>
    </aside>

    <!-- MAIN AREA -->
    <main class="main-area">

      <!-- HEADER / HERO -->
      <header class="hero">
        <div class="hero-left">
          <h1>Dashboard</h1>

          <div class="avatar-row">
            <div class="avatar">
              <img src="image/profile.png" alt="avatar">
            </div>
            <div class="welcome">
              <div class="welcome-title">Welcome back, <strong>Miro!</strong></div>
              <p>start calculate your bill</p>
            </div>
          </div>
        </div>
      </header>

      <!-- TOP CARDS -->
      <section class="top-section">
        <div class="card last-calc">
          <p>Your last calculation</p>
          <h2 id="last_calc_amount">‚Ç± 0.00</h2>
          <span id="last_calc_month">No calculations yet</span>
          <a href="calculator.html"><button class="calculate-btn">Calculate</button></a>
        </div>

        <div class="card tips">
          <h3>üí° Tip</h3>
          <p>Unplug unused appliances to reduce standby power consumption.</p>
          <p>Consider installing small solar panels or solar-powered appliances
             to reduce reliance on grid electricity and lower long-term energy costs.</p>
        </div>
      </section>

      <!-- TABLE -->
      <section class="table-section">
        <h3>Previous Calculations</h3>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Power Consumption (kWh)</th>
              <th>Cost per (kWh)</th>
              <th>Total Bill</th>
            </tr>
          </thead>
          <tbody id="calculations_tbody">
          </tbody>
        </table>
        <a href="history.html" class="view-history">View History</a>
      </section>

    </main>
  </div>

  <!-- FULL JAVASCRIPT -->
  <script>
    // Sidebar toggle
    function toggleMenu() {
      const sidebar = document.querySelector(".sidebar");
      sidebar.classList.toggle("show");
    }

    // Load calculations from Supabase on page load
    document.addEventListener("DOMContentLoaded", async () => {
      if (window.requireAuth) {
        if (!await window.requireAuth()) return; // will redirect to Login if not authenticated
      }

      // Wait for supabase client to be ready
      await new Promise(resolve => {
        const checkInterval = setInterval(() => {
          if (window.supabaseClient) {
            clearInterval(checkInterval);
            resolve();
          }
        }, 100);
        setTimeout(() => { clearInterval(checkInterval); resolve(); }, 5000);
      });

      // Update welcome text based on user info (first-time vs returning)
      try {
        const welcomeEl = document.querySelector(".welcome-title");
        if (welcomeEl && window.supabaseClient) {
          const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
          if (!user || userError) {
            // fallback to a generic welcome if user not available
            welcomeEl.innerHTML = `Welcome back, <strong>Guest</strong>!`;
          } else {
            const displayName = user.user_metadata?.full_name || (user.email && user.email.split('@')[0]) || 'User';

            // Determine if this is the first sign-in by comparing created_at and last_sign_in_at
            // If they are equal or last_sign_in_at is missing (or within a few seconds), treat as first login
            let greeting = 'Welcome back';
            try {
              const created = user.created_at ? new Date(user.created_at).getTime() : null;
              const last = user.last_sign_in_at ? new Date(user.last_sign_in_at).getTime() : null;
              if (!last || !created || Math.abs((last || 0) - (created || 0)) < 5000) {
                greeting = 'Welcome';
              }
            } catch (e) {
              // if parsing fails, fall back to welcome back
              console.debug('Greeting detection parse error', e);
            }

            welcomeEl.innerHTML = `${greeting}, <strong>${escapeHtml(displayName)}</strong>!`;
          }
        }
      } catch (e) {
        console.error('Error setting welcome text', e);
      }

      // Fetch and display calculations
      await loadCalculations();
    });

    // small helper to avoid injecting HTML via names
    function escapeHtml(unsafe) {
      return String(unsafe)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function loadCalculations() {
      try {
        if (typeof supabaseClient === 'undefined' || !supabaseClient) {
          console.warn("Supabase not available");
          loadCalculationsLocally();
          return;
        }

        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        if (userError || !user) {
          console.warn("User not authenticated");
          loadCalculationsLocally();
          return;
        }

        // Fetch calculations from Supabase, ordered by newest first
        const { data, error } = await supabaseClient
          .from("calculations")
          .select("*")
          .eq("user_id", user.id)
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error fetching calculations:", error);
          loadCalculationsLocally();
          return;
        }

        if (data && data.length > 0) {
          // Display last calculation
          const lastCalc = data[0];
          document.getElementById("last_calc_amount").textContent = "‚Ç± " + parseFloat(lastCalc.result).toFixed(2);
          document.getElementById("last_calc_month").textContent = lastCalc.month + " (2025)";

          // Display previous calculations in table (limit to 5)
          const tbody = document.getElementById("calculations_tbody");
          tbody.innerHTML = "";
          data.slice(0, 5).forEach(calc => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${calc.month}</td>
              <td>${parseFloat(calc.power_consumption).toFixed(2)}</td>
              <td>‚Ç± ${parseFloat(calc.cost_per_kwh).toFixed(2)}</td>
              <td>‚Ç± ${parseFloat(calc.result).toFixed(2)}</td>
            `;
            tbody.appendChild(row);
          });
        } else {
          // No calculations found
          const tbody = document.getElementById("calculations_tbody");
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No calculations yet. Go to Calculator to create one.</td></tr>';
        }
      } catch (error) {
        console.error("Error:", error);
        loadCalculationsLocally();
      }
    }

    function loadCalculationsLocally() {
      const calculations = JSON.parse(localStorage.getItem("calculations") || "[]");
      
      if (calculations.length > 0) {
        const lastCalc = calculations[calculations.length - 1];
        document.getElementById("last_calc_amount").textContent = "‚Ç± " + parseFloat(lastCalc.result).toFixed(2);
        document.getElementById("last_calc_month").textContent = lastCalc.month + " (2025)";

        const tbody = document.getElementById("calculations_tbody");
        tbody.innerHTML = "";
        calculations.slice().reverse().slice(0, 5).forEach(calc => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${calc.month}</td>
            <td>${parseFloat(calc.power_consumption).toFixed(2)}</td>
            <td>‚Ç± ${parseFloat(calc.cost_per_kwh).toFixed(2)}</td>
            <td>‚Ç± ${parseFloat(calc.result).toFixed(2)}</td>
          `;
          tbody.appendChild(row);
        });
      } else {
        const tbody = document.getElementById("calculations_tbody");
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No calculations yet. Go to Calculator to create one.</td></tr>';
      }
    }

    // Logout with confirmation
    function handleLogout() {
      const confirmLogout = confirm("Are you sure you want to logout?");

      if (confirmLogout) {
        localStorage.clear(); // clear storage (optional)
        window.location.href = "index.html"; // redirect to home/login
      }
    }
  </script>

</body>
</html>
